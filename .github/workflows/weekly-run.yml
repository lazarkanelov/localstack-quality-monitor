name: Weekly Quality Monitor

on:
  schedule:
    - cron: '0 0 * * 0'  # Sunday at 00:00 UTC
  workflow_dispatch:
    inputs:
      localstack_version:
        description: 'LocalStack version to test'
        required: false
        default: 'latest'
      discovery_limit:
        description: 'Max architectures to discover (0=unlimited)'
        required: false
        default: '100'
      token_budget:
        description: 'Claude API token budget'
        required: false
        default: '500000'

env:
  PYTHON_VERSION: '3.11'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # Step 1: Sync existing artifacts from the artifact repository
  sync:
    name: Sync Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Sync Artifacts from Repository
        env:
          GITHUB_TOKEN: ${{ secrets.ARTIFACT_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
        run: lsqm sync

      - name: Cache artifacts
        uses: actions/cache/save@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-${{ github.run_id }}

  # Step 2: Discover new architectures and save terraform files
  mine:
    name: Discover Architectures
    runs-on: ubuntu-latest
    needs: sync
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Restore artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-${{ github.run_id }}

      - name: Discover New Architectures
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
        run: |
          lsqm --config config.yaml mine --limit ${{ github.event.inputs.discovery_limit || '100' }}

      - name: Save updated artifacts cache
        uses: actions/cache/save@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-mined-${{ github.run_id }}

  # Step 3: Generate test applications using Claude API
  generate:
    name: Generate Test Apps
    runs-on: ubuntu-latest
    needs: mine
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Restore artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-mined-${{ github.run_id }}

      - name: Generate Test Applications
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
          ANTHROPIC_TOKEN_BUDGET: ${{ github.event.inputs.token_budget || '500000' }}
        run: lsqm generate --budget $ANTHROPIC_TOKEN_BUDGET

      - name: Save generated artifacts cache
        uses: actions/cache/save@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-generated-${{ github.run_id }}

  # Step 4: Run validation against LocalStack
  validate:
    name: Validate Against LocalStack
    runs-on: ubuntu-latest
    needs: generate
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Install tflocal
        run: pip install terraform-local

      - name: Install LSQM
        run: pip install -e .

      - name: Restore generated artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-generated-${{ github.run_id }}

      - name: Run Validation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
          LOCALSTACK_VERSION: ${{ github.event.inputs.localstack_version || 'latest' }}
        run: |
          lsqm validate --parallel 2 --timeout 300

      - name: Save validated artifacts cache
        uses: actions/cache/save@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-validated-${{ github.run_id }}

  # Step 5: Generate HTML report and deploy to GitHub Pages
  report:
    name: Generate & Deploy Report
    runs-on: ubuntu-latest
    needs: validate
    if: always() && needs.validate.result != 'cancelled'
    timeout-minutes: 15
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Restore validated artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-validated-${{ github.run_id }}

      - name: Generate Report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
        run: |
          # Get the latest run ID
          RUN_ID=$(ls -t ~/.lsqm/cache/artifacts/runs/ 2>/dev/null | head -1)
          if [ -n "$RUN_ID" ]; then
            lsqm report --run "$RUN_ID" --output ./report-output
          else
            echo "No runs found, generating empty report"
            mkdir -p ./report-output
            echo "<html><body><h1>No validation runs found</h1></body></html>" > ./report-output/index.html
          fi

      - name: Prepare GitHub Pages
        run: |
          # Create pages directory structure
          mkdir -p ./gh-pages

          # Get current date for this week's report
          WEEK_DATE=$(date +%Y-%m-%d)

          # Copy current report to dated folder
          mkdir -p "./gh-pages/reports/$WEEK_DATE"
          cp -r ./report-output/* "./gh-pages/reports/$WEEK_DATE/" 2>/dev/null || true

          # Also copy as latest
          mkdir -p ./gh-pages/latest
          cp -r ./report-output/* ./gh-pages/latest/ 2>/dev/null || true

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-existing
        continue-on-error: true

      - name: Merge with existing reports
        run: |
          # If gh-pages branch exists, merge the reports
          if [ -d "gh-pages-existing/reports" ]; then
            cp -rn gh-pages-existing/reports/* ./gh-pages/reports/ 2>/dev/null || true
          fi

          # Generate index page with all reports
          cat > ./gh-pages/index.html << 'INDEXEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>LocalStack Quality Monitor - Reports</title>
              <script src="https://cdn.tailwindcss.com"></script>
              <script>
                  tailwind.config = { darkMode: 'class' }
              </script>
          </head>
          <body class="bg-slate-950 text-gray-100 min-h-screen">
              <div class="container mx-auto px-4 py-12 max-w-4xl">
                  <header class="text-center mb-12">
                      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                          LocalStack Quality Monitor
                      </h1>
                      <p class="text-slate-400 mt-2">Weekly AWS Architecture Compatibility Reports</p>
                  </header>

                  <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 mb-8">
                      <h2 class="text-xl font-semibold mb-4 flex items-center">
                          <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                          </svg>
                          Latest Report
                      </h2>
                      <a href="./latest/" class="block p-4 bg-slate-800 hover:bg-slate-700 rounded-lg transition">
                          <div class="flex items-center justify-between">
                              <span class="text-lg font-medium">View Current Report</span>
                              <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                              </svg>
                          </div>
                      </a>
                  </div>

                  <div class="bg-slate-900 rounded-xl border border-slate-800 p-6">
                      <h2 class="text-xl font-semibold mb-4 flex items-center">
                          <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          </svg>
                          Report History
                      </h2>
                      <div id="report-list" class="space-y-2">
                          <!-- Populated by JavaScript -->
                      </div>
                  </div>

                  <footer class="text-center mt-12 text-slate-500 text-sm">
                      <p>Powered by <a href="https://localstack.cloud" class="text-blue-400 hover:underline">LocalStack</a></p>
                  </footer>
              </div>

              <script>
                  // This will be populated during build
                  const reports = REPORT_LIST_PLACEHOLDER;

                  const listEl = document.getElementById('report-list');
                  if (reports.length === 0) {
                      listEl.innerHTML = '<p class="text-slate-500">No historical reports available yet.</p>';
                  } else {
                      reports.forEach(report => {
                          const div = document.createElement('a');
                          div.href = './reports/' + report + '/';
                          div.className = 'block p-3 bg-slate-800 hover:bg-slate-700 rounded-lg transition';
                          div.innerHTML = `
                              <div class="flex items-center justify-between">
                                  <span class="font-mono text-sm">${report}</span>
                                  <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                  </svg>
                              </div>
                          `;
                          listEl.appendChild(div);
                      });
                  }
              </script>
          </body>
          </html>
          INDEXEOF

          # Generate the report list and inject it
          REPORT_DIRS=$(ls -r ./gh-pages/reports/ 2>/dev/null | head -52 || echo "")
          REPORT_JSON="["
          FIRST=true
          for dir in $REPORT_DIRS; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              REPORT_JSON="$REPORT_JSON,"
            fi
            REPORT_JSON="$REPORT_JSON\"$dir\""
          done
          REPORT_JSON="$REPORT_JSON]"

          sed -i "s|REPORT_LIST_PLACEHOLDER|$REPORT_JSON|g" ./gh-pages/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: true

      - name: Save final artifacts cache
        uses: actions/cache/save@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-final-${{ github.run_id }}

      - name: Upload HTML report artifact
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ github.run_id }}
          path: ./report-output/
          retention-days: 90

  # Step 6: Compare with previous run
  compare:
    name: Compare Results
    runs-on: ubuntu-latest
    needs: report
    timeout-minutes: 10
    outputs:
      has_regressions: ${{ steps.compare.outputs.has_regressions }}
      regression_count: ${{ steps.compare.outputs.regression_count }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Restore final artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-final-${{ github.run_id }}

      - name: Compare with Previous Run
        id: compare
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
        run: |
          if lsqm compare --output json > comparison.json 2>&1; then
            echo "has_regressions=false" >> $GITHUB_OUTPUT
            echo "regression_count=0" >> $GITHUB_OUTPUT
          else
            echo "has_regressions=true" >> $GITHUB_OUTPUT
            count=$(jq '.regressions_count // 0' comparison.json 2>/dev/null || echo "0")
            echo "regression_count=$count" >> $GITHUB_OUTPUT
          fi

      - name: Upload comparison results
        uses: actions/upload-artifact@v4
        with:
          name: comparison-results
          path: comparison.json
          retention-days: 30

  # Step 7: Push all artifacts to the artifact repository
  push:
    name: Push to Artifact Repo
    runs-on: ubuntu-latest
    needs: [report, compare]
    if: always() && needs.report.result == 'success'
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Restore final artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.lsqm/cache/artifacts
          key: lsqm-artifacts-final-${{ github.run_id }}

      - name: Configure Git
        run: |
          git config --global user.name "LSQM Bot"
          git config --global user.email "lsqm@github-actions.bot"

      - name: Push All Artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.ARTIFACT_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
        run: |
          lsqm push --message "Weekly run $(date +%Y-%m-%d)"

  # Step 8: Send notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [compare, push]
    if: always()
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install LSQM
        run: pip install -e .

      - name: Send Slack Notification
        if: vars.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
        run: lsqm notify

      - name: Create Summary
        env:
          PAGES_URL: ${{ github.event.repository.homepage || format('https://{0}.github.io/{1}', github.repository_owner, github.event.repository.name) }}
        run: |
          echo "## LocalStack Quality Monitor - Weekly Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run completed:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.compare.outputs.has_regressions }}" == "true" ]; then
            echo ":warning: **Regressions detected:** ${{ needs.compare.outputs.regression_count }}" >> $GITHUB_STEP_SUMMARY
          else
            echo ":white_check_mark: **No regressions detected**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### View Reports" >> $GITHUB_STEP_SUMMARY
          echo "- [Latest Report](${PAGES_URL}/latest/)" >> $GITHUB_STEP_SUMMARY
          echo "- [All Reports](${PAGES_URL}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform architectures discovered and validated" >> $GITHUB_STEP_SUMMARY
          echo "- Python test applications generated" >> $GITHUB_STEP_SUMMARY
          echo "- Validation results stored" >> $GITHUB_STEP_SUMMARY
